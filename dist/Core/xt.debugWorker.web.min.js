var XTDebugger = /** @class */ (function () {
    function XTDebugger() {
        this.socket = undefined;
        this.reconnectTimer = 0;
        this.openTS = 0;
    }
    XTDebugger.prototype.connect = function (IP, port) {
        var _this = this;
        if (this.socket && this.socket.readyState == 1) {
            this.socket.close();
        }
        this.socket = new WebSocket('ws://' + IP + ":" + port + "/");
        this.socket.onopen = function () {
            _this.openTS = _this.openTS == 0 ? new Date().getTime() : _this.openTS;
            if (_this.socket) {
                var name = "Browser";
                if (navigator.userAgent.indexOf("iPhone") >= 0) {
                    name = "iPhone Browser";
                }
                else if (navigator.userAgent.indexOf("Android") >= 0) {
                    name = "Android Browser";
                }
                _this.socket.send(JSON.stringify({
                    type: "active",
                    name: name
                }));
            }
        };
        this.socket.onmessage = (function (ev) {
            try {
                var obj = JSON.parse(ev.data);
                if (obj.action === "reload") {
                    _this.handleReload(_atob(obj.source));
                }
                else if (obj.action === "clearBreakPoint") {
                    _this.handleClearBreakPoint(obj);
                }
                else if (obj.action === "clearBreakPoints") {
                    _this.handleClearBreakPoints(obj);
                }
                else if (obj.action === "setBreakPoint") {
                    _this.handleSetBreakPoint(obj);
                }
                // else if ([obj[@"action"] isEqualToString:@"eval"]) {
                //     [self handleEval:obj];
                // }
            }
            catch (error) { }
        });
        this.socket.onclose = function () {
            clearTimeout(_this.reconnectTimer);
            _this.reconnectTimer = setTimeout(function () {
                _this.connect(IP, port);
            }, 1000);
        };
        this.socket.onerror = function () {
            clearTimeout(_this.reconnectTimer);
            _this.reconnectTimer = setTimeout(function () {
                _this.connect(IP, port);
            }, 1000);
        };
    };
    XTDebugger.prototype.handleReload = function (source) {
        postMessage({ action: "reload", source: source, force: !(new Date().getTime() - this.openTS < 2000) });
    };
    XTDebugger.prototype.handleClearBreakPoint = function (obj) {
        postMessage({ action: "clearBreakPoint", bpIdentifier: obj["path"] + ":" + obj["line"] });
    };
    XTDebugger.prototype.handleClearBreakPoints = function (obj) {
        postMessage({ action: "clearBreakPoints", path: obj["path"] });
    };
    XTDebugger.prototype.handleSetBreakPoint = function (obj) {
        postMessage({ action: "setBreakPoint", bpIdentifier: obj["path"] + ":" + obj["line"] });
    };
    XTDebugger.prototype.sendLog = function (value) {
        if (this.socket) {
            this.socket.send(JSON.stringify({
                type: "console.log",
                payload: btoa(value),
                bpIdentifier: "console"
            }));
        }
    };
    XTDebugger.sharedDebugger = new XTDebugger();
    return XTDebugger;
}());
var _atob = function (str) {
    return decodeURIComponent(Array.prototype.map.call(atob(str), function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
};
onmessage = function (event) {
    if (event.data) {
        if (event.data["type"] === "connect") {
            XTDebugger.sharedDebugger.connect(event.data["IP"], event.data["port"]);
        }
        else if (event.data["type"] === "log") {
            XTDebugger.sharedDebugger.sendLog(event.data["payload"]);
        }
    }
};
